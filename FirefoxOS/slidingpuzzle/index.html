<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7;" > 
	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="style/style.css">
	<script type="text/javascript" src="include/pagehandler.js"></script>
	<script type="text/javascript" src="include/slidingpuzzle.js"></script>
	<script type="text/javascript" src="include/imageslidingpuzzle.js"></script>
	<title>Slider Puzzle</title>
	<script type="text/javascript">
		var pageHandler = null;
		var slider = null;
		var settings = {
			tileCount : 3,
			image : null,
			loaded : false
		};

		function ShowMainPage ()
		{
			pageHandler.SetToPage (0);
			Resize ();
		}
		
		function ShowSettings ()
		{
			pageHandler.SetToPage (1);
			Resize ();
		}
		
		function SelectImage ()
		{
			try {
				var activity = new MozActivity ({
					name: 'pick',
					data: {
						type: 'image/*'
					}
				});
				activity.onsuccess = function () {
					ShowMainPage ();
					settings.loaded = false;
					SetNewImage (URL.createObjectURL (this.result.blob));
				}

				activity.onerror = function () {
				}
			} catch (ex) {
				alert ('This is not supported on your device.');
			}
		}

		function Restart ()
		{
			SetNewImage ();
			ShowMainPage ();
		}
		
		function ChangeSize (size)
		{
			settings.tileCount = size;
			Restart ();
		}
		
		function OnWin ()
		{
			alert ('Congratulations!');
			slider.Enable (false);
		}
		
		function SetNewImage (imageUrl)
		{
			function ImageLoaded (image)
			{
				function Shuffle ()
				{
					slider.Shuffle (50);
					slider.Enable (true);
				}

				slider.SetImage (image);
				slider.Enable (false);
				
				setTimeout (Shuffle, 3000);
			}
		
			slider.Generate (settings.tileCount);
			
			if (!settings.loaded || imageUrl !== undefined) {
				settings.image = new Image ();
				settings.image.src = imageUrl;
				settings.image.onload = function () {
					settings.loaded = true;
					ImageLoaded (this);
				};
			} else {
				ImageLoaded (settings.image);
			}
		}

		function Resize ()
		{
			var page = pageHandler.GetPage ();
			var menus = document.getElementsByClassName ('menu');
			var contents = document.getElementsByClassName ('content');
			
			var menu = menus[page];
			var content = contents[page];
			
			if (page == 0) {
				var margin = 20;
				var newWidth = window.innerWidth - margin;
				var newHeight = window.innerHeight - menu.clientHeight - margin;
				content.style.width = (newWidth - newWidth % settings.tileCount) + 'px';
				content.style.height = (newHeight - newHeight % settings.tileCount) + 'px';
				content.style.margin = (margin / 2) + 'px';
				if (slider !== null) {
					slider.Resize ();
				}
			} else {
				content.style.width = window.innerWidth + 'px';
				content.style.height = (window.innerHeight - menu.clientHeight) + 'px';
			}
		}

		function Load ()
		{
			pageHandler = new PageHandler ();
			pageHandler.SetToPage (0);

			if (window.screen.mozLockOrientation) {
				window.screen.mozLockOrientation ('portrait');
			}
			
			window.onresize = Resize;
			Resize ();

			var table = document.getElementById ('table');
			slider = new ImageSlidingPuzzle ();
			slider.Init (table, OnWin);
			SetNewImage ('firefoxos.png');
		}
	
	    window.onload = function ()
		{
			Load ();
		}
	</script>

</head>

<body>
	<div class="page">
		<div class="menu" id="mainmenu">
			<div class="text" id="maintext">sliding</div>
			<a href="javascript:ShowSettings ();"><div class="righticonbutton"><img src="images/menu.png"></div></a>
		</div>
		<div id="table" class="content">
		</div>
	</div>
	<div class="page">
		<div class="menu" id="mainmenu">
			<div class="text" id="maintext">settings</div>
			<a href="javascript:ShowMainPage ();"><div class="righticonbutton"><img src="images/back.png"></div></a>
		</div>
		<div class="content">
			<div class="parametertitle">tools</div>
			<a href="javascript:SelectImage ();"><div class="parameter">select image</div></a>
			<a href="javascript:Restart ();"><div class="parameter">restart</div></a>
			<div class="parametertitle">size</div>
			<a href="javascript:ChangeSize (3);"><div class="parameter">3 x 3</div></a>
			<a href="javascript:ChangeSize (4);"><div class="parameter">4 x 4</div></a>
			<a href="javascript:ChangeSize (5);"><div class="parameter">5 x 5</div></a>
		</div>
	</div>
</body>

</html>
